#!/bin/bash
# Git Commit Message Hook - Conventional Commits Validation
# Usage: Copy to .git/hooks/commit-msg and make executable

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(head -1 "$COMMIT_MSG_FILE")

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Conventional commit pattern
# Format: type(scope): subject
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert
PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z-]+\))?: .{10,}$"

# Special cases that are allowed
MERGE_PATTERN="^Merge branch"
REVERT_PATTERN="^Revert"

if [[ $COMMIT_MSG =~ $PATTERN ]] || [[ $COMMIT_MSG =~ $MERGE_PATTERN ]] || [[ $COMMIT_MSG =~ $REVERT_PATTERN ]]; then
    echo -e "${GREEN}✓ Commit message format is valid${NC}"
    exit 0
else
    echo -e "${RED}✗ Invalid commit message format!${NC}"
    echo ""
    echo -e "${YELLOW}Expected format:${NC}"
    echo "  <type>(<scope>): <subject>"
    echo ""
    echo -e "${YELLOW}Types:${NC}"
    echo "  feat:     New feature"
    echo "  fix:      Bug fix"
    echo "  docs:     Documentation changes"
    echo "  style:    Code style changes (formatting, semicolons, etc)"
    echo "  refactor: Code refactoring"
    echo "  perf:     Performance improvements"
    echo "  test:     Adding or updating tests"
    echo "  build:    Build system changes"
    echo "  ci:       CI/CD changes"
    echo "  chore:    Other changes (dependencies, config, etc)"
    echo "  revert:   Revert previous commit"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  feat: add user authentication"
    echo "  fix(api): resolve null pointer exception"
    echo "  docs(readme): update installation instructions"
    echo "  refactor(strategy): extract common trading logic"
    echo ""
    echo -e "${YELLOW}Your message:${NC}"
    echo "  $COMMIT_MSG"
    exit 1
fi
